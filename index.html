<html>
<head>
  <title>Reddit</title>
  <link rel="stylesheet" href="styles/style.css" type="text/css" media="screen">
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script src="scripts/handlebars.runtime.js"></script>
  <script src="scripts/templates.js"></script>

  <script>
    $(function() {
      var baseURL = "http://www.reddit.com/",
          suffix  = ".json?jsonp=?",
          currentPostIndex = 0;

      var V = {
        // View
        postTemplate: Handlebars.templates['post'],
        imageTemplate: Handlebars.templates['postimage'],
        youtubeTemplate: Handlebars.templates['postyoutube'],
        body: $("body"),
        posts: $("#posts ul"),
        postItems: ""
      };

      $.getJSON(baseURL + suffix, function(reddit) {
        console.log(reddit.data);
        parsePosts(reddit.data.children);
      });

      var parsePosts = function(posts) {
        var list = [];
        for (var i = 0; i < posts.length; i++) {
          var p = posts[i].data;
          if (p.domain === "youtube.com") {
            p.youtubeId = p.url.split('v=')[1];
            list.push(V.youtubeTemplate(p));
          } else if (isUrlAnImage(p.url)) {
            list.push(V.imageTemplate(p));
          } else {
            list.push(V.postTemplate(p));
          }
        }

        V.posts.append(list);
        V.postItems = V.posts.find(".post-link");
        $(V.postItems[currentPostIndex]).addClass("selected");
      };

      function isUrlAnImage(url) {
        return(url.match(/\.(jpeg|jpg|gif|png)$/) != null);
      }

      V.body.keypress(function(event) {
        if (event.which == 106) {
          // pressing j
          if (currentPostIndex + 1 < V.postItems.length) {
            $(V.postItems[currentPostIndex]).removeClass("selected");
            $(V.postItems[++currentPostIndex]).addClass("selected");
            V.body.scrollTop($(V.postItems[currentPostIndex]).offset().top);
          }
        } else if (event.which == 107) {
          // pressing k
          if (currentPostIndex - 1 >= 0) {
            $(V.postItems[currentPostIndex]).removeClass("selected");
            $(V.postItems[--currentPostIndex]).addClass("selected");
            V.body.scrollTop($(V.postItems[currentPostIndex]).offset().top);
          }
        } else if (event.which == 111) {
          // pressing o
          window.open($(V.postItems[currentPostIndex]).attr("href"));
        }
      });

    });
  </script>
</head>
<body>

<div id="container">
  <div id="posts">
    <ul></ul>
  </div>
</div>

</body>
</html>